# Sync Check - Verifica sincronizacao entre Backend e Frontend
name: Sync Check

on:
  push:
    branches: [main]
    paths:
      - 'src/packages/**'
      - 'src/api/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/packages/**'
      - 'src/api/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  typecheck:
    name: TypeScript Sync Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Install Dependencies
        working-directory: src
        run: npm ci

      - name: TypeCheck - Shared Package
        working-directory: src/packages/shared
        run: npx tsc --noEmit
        continue-on-error: false

      - name: TypeCheck - API Package
        working-directory: src/packages/api
        run: npx tsc --noEmit
        continue-on-error: false

      - name: TypeCheck - Web Package
        working-directory: src/packages/web
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Build - All Packages
        working-directory: src
        run: npm run build

      - name: Verify Shared Types Import
        working-directory: src
        run: |
          echo "Verificando importacoes de tipos compartilhados..."
          
          # Verificar se API importa do shared
          if grep -r "@planac/shared" packages/api/src/ > /dev/null 2>&1; then
            echo "API importa tipos do shared package"
          else
            echo "AVISO: API nao importa tipos do shared package"
          fi
          
          # Verificar se Web usa tipos consistentes
          echo "Verificando consistencia de tipos..."
          
          # Listar interfaces do shared
          echo "=== Interfaces no Shared ==="
          grep -E "^export (interface|type)" packages/shared/src/index.ts || true
          
          # Listar interfaces do web/types
          echo "=== Interfaces no Web ==="
          grep -E "^export (interface|type)" packages/web/src/types/index.ts || true

  api-contract-check:
    name: API Contract Validation
    runs-on: ubuntu-latest
    needs: typecheck

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Install Dependencies
        working-directory: src
        run: npm ci

      - name: Run API Unit Tests
        working-directory: src/packages/api
        run: npm test -- --run --passWithNoTests
        continue-on-error: true

      - name: Run Web Unit Tests
        working-directory: src/packages/web
        run: npm test -- --run --passWithNoTests
        continue-on-error: true

      - name: Sync Check Summary
        if: always()
        run: |
          echo "## Sync Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Verificados:" >> $GITHUB_STEP_SUMMARY
          echo "- **Shared**: Tipos e utilitarios compartilhados" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: Backend (Cloudflare Workers)" >> $GITHUB_STEP_SUMMARY
          echo "- **Web**: Frontend (React + Vite)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verificacoes Realizadas:" >> $GITHUB_STEP_SUMMARY
          echo "1. TypeScript compilation em todos os pacotes" >> $GITHUB_STEP_SUMMARY
          echo "2. Build completo do monorepo" >> $GITHUB_STEP_SUMMARY
          echo "3. Importacoes de tipos compartilhados" >> $GITHUB_STEP_SUMMARY
          echo "4. Testes unitarios (API e Web)" >> $GITHUB_STEP_SUMMARY
