name: E2E Tests - Playwright

on:
  push:
    branches: [main]
    paths:
      - 'src/packages/web/**'
  pull_request:
    branches: [main]
  schedule:
    # Roda todo dia Ã s 06:00 UTC (03:00 BRT)
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª Testes E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Instalar dependÃªncias
        working-directory: src/packages/web
        run: |
          npm install
          npx playwright install --with-deps chromium

      - name: ğŸ§ª Rodar testes E2E
        id: e2e_tests
        working-directory: src/packages/web
        continue-on-error: true
        run: |
          npx playwright test --reporter=json 2>&1 | tee test-output.txt || true
          # Salvar resultado em arquivo
          if grep -q "passed" test-output.txt; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Processar resultados
        id: process_results
        working-directory: src/packages/web
        run: |
          if [ -f test-results/results.json ]; then
            PASSED=$(cat test-results/results.json | jq '.stats.expected // 0' 2>/dev/null || echo "0")
            FAILED=$(cat test-results/results.json | jq '.stats.unexpected // 0' 2>/dev/null || echo "0")
          else
            # Tentar extrair do output
            PASSED=$(grep -oP '\d+(?= passed)' test-output.txt 2>/dev/null | head -1 || echo "0")
            FAILED=$(grep -oP '\d+(?= failed)' test-output.txt 2>/dev/null | head -1 || echo "0")
          fi
          
          echo "passed=${PASSED:-0}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED:-0}" >> $GITHUB_OUTPUT
          
          if [ "${FAILED:-0}" -gt 0 ] || [ "${FAILED:-0}" = "" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            
            # Extrair erros do output
            ERRORS=$(grep -A5 "Error:" test-output.txt 2>/dev/null | head -30 || echo "Detalhes nÃ£o disponÃ­veis")
            echo "errors<<EOF" >> $GITHUB_OUTPUT
            echo "$ERRORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¸ Upload Screenshots (se falhou)
        if: steps.process_results.outputs.status == 'failed'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: src/packages/web/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ“‹ Upload RelatÃ³rio HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: src/packages/web/playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ› Criar Issue se testes falharam
        if: steps.process_results.outputs.status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const failed = '${{ steps.process_results.outputs.failed }}' || '?';
            const passed = '${{ steps.process_results.outputs.passed }}' || '?';
            const errors = `${{ steps.process_results.outputs.errors }}` || 'Detalhes nÃ£o disponÃ­veis';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-test-failure'
            });
            
            const issueBody = `## ğŸ”´ Testes E2E Falharam!

**Data:** ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}
**Commit:** \`${context.sha.substring(0, 7)}\`
**Branch:** \`${context.ref.replace('refs/heads/', '')}\`

### ğŸ“Š Resumo
| Status | Quantidade |
|--------|------------|
| âœ… Passou | ${passed} |
| âŒ Falhou | ${failed} |

### ğŸ› Erros encontrados
\`\`\`
${errors.substring(0, 2000)}
\`\`\`

### ğŸ”— Links
- [Ver execuÃ§Ã£o completa](${runUrl})
- [Baixar screenshots](${runUrl}#artifacts)

### ğŸ¤– InstruÃ§Ã£o para Claude
> Copie esta issue e cole no chat com Claude pedindo:
> **"Verifique esta issue de testes E2E e corrija os erros"**

---
*Issue criada automaticamente pelo GitHub Actions*
`;

            if (existingIssues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## ğŸ”„ Nova falha detectada!\n\n${issueBody}`
              });
              console.log(`ComentÃ¡rio adicionado Ã  issue #${existingIssues.data[0].number}`);
            } else {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ”´ [E2E] Testes falharam - ${failed} erro(s)`,
                body: issueBody,
                labels: ['e2e-test-failure', 'bug', 'automated']
              });
              console.log(`Issue #${issue.data.number} criada`);
            }

      - name: âœ… Fechar Issue se testes passaram
        if: steps.process_results.outputs.status == 'passed'
        uses: actions/github-script@v7
        with:
          script: |
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-test-failure'
            });
            
            for (const issue of existingIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## âœ… Testes corrigidos!\n\nTodos os testes E2E passaram. Issue fechada automaticamente.\n\n**Commit:** \`${context.sha.substring(0, 7)}\``
              });
              
              console.log(`Issue #${issue.number} fechada`);
            }

      - name: ğŸ“Š Resultado Final
        run: |
          echo "Status: ${{ steps.process_results.outputs.status }}"
          echo "Passou: ${{ steps.process_results.outputs.passed }}"
          echo "Falhou: ${{ steps.process_results.outputs.failed }}"
          if [ "${{ steps.process_results.outputs.status }}" == "passed" ]; then
            echo "âœ… Todos os testes passaram!"
            exit 0
          else
            echo "âŒ Alguns testes falharam. Issue criada/atualizada no GitHub."
            exit 1
          fi
