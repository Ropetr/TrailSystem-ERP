name: E2E Tests - Playwright

on:
  push:
    branches: [main]
    paths:
      - 'src/packages/web/**'
  pull_request:
    branches: [main]
  schedule:
    # Roda todo dia √†s 06:00 UTC (03:00 BRT)
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  test:
    name: üß™ Testes E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/packages/web/package-lock.json

      - name: üì¶ Instalar depend√™ncias
        working-directory: src/packages/web
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: üß™ Rodar testes E2E
        id: e2e_tests
        working-directory: src/packages/web
        continue-on-error: true
        run: npx playwright test --reporter=json > test-results.json 2>&1 || true

      - name: üìä Processar resultados
        id: process_results
        working-directory: src/packages/web
        run: |
          if [ -f test-results.json ]; then
            # Extrair estat√≠sticas
            PASSED=$(cat test-results.json | jq '.stats.expected // 0')
            FAILED=$(cat test-results.json | jq '.stats.unexpected // 0')
            SKIPPED=$(cat test-results.json | jq '.stats.skipped // 0')
            
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            
            if [ "$FAILED" -gt 0 ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              
              # Extrair detalhes dos testes que falharam
              FAILED_TESTS=$(cat test-results.json | jq -r '
                .suites[]?.suites[]?.specs[]? | 
                select(.ok == false) | 
                "- **\(.title)** em `\(.file)`\n  Erro: \(.tests[0].results[0].error.message // "Erro desconhecido")"
              ' | head -20)
              
              # Escapar para multiline
              FAILED_TESTS="${FAILED_TESTS//'%'/'%25'}"
              FAILED_TESTS="${FAILED_TESTS//$'\n'/'%0A'}"
              FAILED_TESTS="${FAILED_TESTS//$'\r'/'%0D'}"
              
              echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
              echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "status=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
          fi

      - name: üì∏ Upload Screenshots (se falhou)
        if: steps.process_results.outputs.status == 'failed'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: src/packages/web/test-results/
          retention-days: 7

      - name: üìã Upload Relat√≥rio HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: src/packages/web/playwright-report/
          retention-days: 7

      - name: üêõ Criar Issue se testes falharam
        if: steps.process_results.outputs.status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const failed = ${{ steps.process_results.outputs.failed }};
            const passed = ${{ steps.process_results.outputs.passed }};
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            // Verificar se j√° existe issue aberta
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-test-failure'
            });
            
            const issueBody = `## üî¥ Testes E2E Falharam!

            **Data:** ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref.replace('refs/heads/', '')}

            ### üìä Resumo
            | Status | Quantidade |
            |--------|------------|
            | ‚úÖ Passou | ${passed} |
            | ‚ùå Falhou | ${failed} |

            ### üêõ Testes que falharam
            ${{ steps.process_results.outputs.failed_tests || 'Detalhes n√£o dispon√≠veis' }}

            ### üîó Links
            - [Ver execu√ß√£o completa](${runUrl})
            - [Baixar screenshots](${runUrl}#artifacts)
            - [Baixar relat√≥rio HTML](${runUrl}#artifacts)

            ### ü§ñ Instru√ß√£o para Claude
            > Abra esta issue no chat com Claude e pe√ßa:
            > "Verifique a issue #[N√öMERO] de testes E2E e corrija os erros"

            ---
            *Issue criada automaticamente pelo GitHub Actions*
            `;

            if (existingIssues.data.length > 0) {
              // Atualizar issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## üîÑ Nova falha detectada!\n\n${issueBody}`
              });
              console.log(`Coment√°rio adicionado √† issue #${existingIssues.data[0].number}`);
            } else {
              // Criar nova issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üî¥ [E2E] Testes falharam - ${failed} erro(s)`,
                body: issueBody,
                labels: ['e2e-test-failure', 'bug', 'automated']
              });
              console.log(`Issue #${issue.data.number} criada`);
            }

      - name: ‚úÖ Fechar Issue se testes passaram
        if: steps.process_results.outputs.status == 'passed'
        uses: actions/github-script@v7
        with:
          script: |
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-test-failure'
            });
            
            for (const issue of existingIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ‚úÖ Testes corrigidos!\n\nTodos os testes E2E passaram. Issue fechada automaticamente.\n\n**Commit:** ${context.sha.substring(0, 7)}`
              });
              
              console.log(`Issue #${issue.number} fechada`);
            }

      - name: üìä Resultado Final
        run: |
          if [ "${{ steps.process_results.outputs.status }}" == "passed" ]; then
            echo "‚úÖ Todos os testes passaram!"
            exit 0
          else
            echo "‚ùå Alguns testes falharam. Issue criada no GitHub."
            exit 1
          fi
